<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>Test Portal ‚Äì Exam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { background: linear-gradient(145deg, #f0f4ff 0%, #e6edfa 100%); min-height: 100vh; }
    .glass-panel { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 25px 40px -15px rgba(0,0,0,0.1); }
    .option { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; background: white; }
    .option:hover { background: #eff6ff; border-color: #3b82f6; transform: translateY(-2px); }
    .option.selected { background: #dbeafe; border-color: #2563eb; box-shadow: 0 8px 15px -6px #3b82f6; }
    .timer-critical { color: #dc2626; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    /* Question palette */
    .palette-btn {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
      border: 2px solid transparent;
    }
    .palette-btn:hover { transform: scale(1.1); border-color: #2563eb; }
    .palette-correct { background: #22c55e; color: white; }
    .palette-wrong { background: #ef4444; color: white; }
    .palette-answered { background: #3b82f6; color: white; } /* answered but correctness unknown? we will update after submit */
    .palette-skipped { background: #9ca3af; color: white; }
    .palette-current { border: 3px solid #1e3a8a; box-shadow: 0 0 0 2px white; }
    /* Loader */
    .loader { display: flex; justify-content: center; align-items: center; gap: 8px; }
    .loader span { width: 12px; height: 12px; background-color: #3b82f6; border-radius: 50%; display: inline-block; animation: pulse 1.2s infinite ease-in-out; }
    .loader span:nth-child(2) { animation-delay: 0.2s; }
    .loader span:nth-child(3) { animation-delay: 0.4s; }
    #globalLoader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
      display: flex; justify-content: center; align-items: center; z-index: 9999;
    }
    /* Result Modal */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
      display: flex; justify-content: center; align-items: center; z-index: 10000;
    }
    .modal-content { background: white; border-radius: 2rem; padding: 2rem; max-width: 400px; width: 90%; }
  </style>
</head>
<body class="font-sans p-4 md:p-6">
  <!-- Global Loader -->
  <div id="globalLoader" class="hidden">
    <div class="loader"><span></span><span></span><span></span></div>
  </div>

  <!-- Result Modal (hidden by default) -->
  <div id="resultModal" class="modal hidden">
    <div class="modal-content glass-panel text-center">
      <h2 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-4">üéâ Test Submitted</h2>
      <div id="resultDetails" class="space-y-2 text-lg">
        <!-- filled by JS -->
      </div>
      <button onclick="closeResultModal()" class="mt-6 bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-8 py-3 rounded-full font-semibold shadow-lg">
        Close
      </button>
    </div>
  </div>

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="glass-panel rounded-3xl p-5 mb-6 flex flex-wrap justify-between items-center">
      <div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-700 bg-clip-text text-transparent" id="testName">Loading...</h1>
        <p class="text-sm text-gray-600" id="studentInfo"></p>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex space-x-2">
          <button onclick="setLanguage('en')" class="px-3 py-1 bg-white/70 text-blue-800 rounded-full text-sm font-medium shadow-sm">EN</button>
          <button onclick="setLanguage('hi')" class="px-3 py-1 bg-white/70 text-indigo-800 rounded-full text-sm font-medium shadow-sm">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">‚è±Ô∏è Time Left</div>
          <div id="timer" class="text-2xl font-mono font-bold text-gray-800">00:00</div>
        </div>
      </div>
    </div>

    <!-- Student Profile & Previous Results -->
    <div class="glass-panel rounded-3xl p-5 mb-6">
      <details open>
        <summary class="font-semibold text-lg cursor-pointer">üë§ My Profile & Previous Tests</summary>
        <div id="previousResults" class="mt-3 text-sm overflow-x-auto">
          Loading your history...
        </div>
      </details>
    </div>

    <!-- Question Palette -->
    <div class="glass-panel rounded-3xl p-5 mb-6">
      <h3 class="font-semibold text-lg mb-3">üìå Question Navigator</h3>
      <div id="paletteContainer" class="flex flex-wrap gap-3 justify-center">
        <!-- injected by JS -->
      </div>
    </div>

    <!-- Question Card -->
    <div id="questionContainer" class="glass-panel rounded-3xl p-6 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <span class="text-sm font-medium bg-white/70 px-4 py-2 rounded-full shadow-sm" id="questionCounter">Q1/10</span>
        <span class="text-sm text-gray-500" id="marksScheme">‚≠ê Marks: +? / -? / 0</span>
      </div>
      <div id="questionText" class="text-lg md:text-xl font-medium text-gray-800 mb-4"></div>
      <div id="questionImage" class="mb-6 flex justify-center bg-white/50 p-4 rounded-xl hidden">
        <img src="" alt="Question image" class="max-h-64 rounded-lg shadow-md">
      </div>
      <div id="optionsContainer" class="space-y-3 mt-6"></div>
      <div class="flex justify-between mt-8 pt-4 border-t border-white/30">
        <button onclick="prevQuestion()" id="prevBtn" class="px-6 py-2 bg-white/80 hover:bg-white rounded-full text-gray-700 font-medium flex items-center gap-2 disabled:opacity-50 shadow-sm transition">
          <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button onclick="nextQuestion()" id="nextBtn" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white rounded-full font-medium flex items-center gap-2 shadow-lg transition">
          Next <i class="fas fa-arrow-right"></i>
        </button>
        <button onclick="submitTest()" id="submitBtn" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-full font-medium hidden shadow-lg transition">
          <i class="fas fa-check-circle"></i> Submit
        </button>
      </div>
    </div>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4REt1W-ub1jd1uMz-uD-Rth3rTXo5ALuZFSVz1qXph9zu1XevbMgTCphCTTOhShDcqA/exec';
    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'index.html';

    // ---------- State ----------
    let testData = null, questions = [], currentIndex = 0, testId = null;
    let answers = {};        // { qId: { selected: '1', isCorrect: boolean } }
    let questionStatus = []; // per index: 'correct','wrong','skipped','visited'
    let timeLeft = 0, timerInterval;
    let currentLang = 'en';
    let correctMarks = 1, wrongMarks = 0, skipMarks = 0;

    // ---------- Loader ----------
    function showLoader() { document.getElementById('globalLoader').classList.remove('hidden'); }
    function hideLoader() { document.getElementById('globalLoader').classList.add('hidden'); }
    async function fetchAPI(body) {
      showLoader();
      try {
        const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(body) });
        return await res.json();
      } finally { hideLoader(); }
    }

    // ---------- Initialization ----------
    window.onload = async () => {
      document.getElementById('studentInfo').innerHTML = `üë§ ${localStorage.getItem('studentName') || ''} (ID: ${localStorage.getItem('studentId')})`;
      await loadStudentResults();
      await loadTest();
    };

    async function loadStudentResults() {
      const data = await fetchAPI({ action: 'getStudentResults', token });
      if (data.status === 'success' && data.data.length) {
        let html = '<table class="w-full text-left"><thead><tr class="border-b"><th>Test</th><th>Score</th><th>Rank</th><th>Date</th></tr></thead><tbody>';
        data.data.forEach(r => {
          html += `<tr><td>${r.testName}</td><td>${r.score}</td><td>#${r.rank}</td><td>${new Date(r.submitted).toLocaleDateString()}</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('previousResults').innerHTML = html;
      } else {
        document.getElementById('previousResults').innerHTML = '<p class="text-gray-500">No previous tests found.</p>';
      }
    }

    async function loadTest() {
      const testRes = await fetchAPI({ action: 'getTest', token });
      if (testRes.status !== 'success') { alert('No test available'); window.location.href = 'index.html'; return; }
      testData = testRes.data;
      testId = testData.testId;
      correctMarks = parseFloat(testData.correctMarks) || 1;
      wrongMarks = parseFloat(testData.wrongMarks) || 0;
      skipMarks = parseFloat(testData.skipMarks) || 0;
      document.getElementById('testName').innerText = testData.testName;
      document.getElementById('marksScheme').innerHTML = `‚≠ê Marks: +${correctMarks} / ${wrongMarks} / ${skipMarks} (skip)`;
      timeLeft = (parseInt(testData.duration) || 30) * 60;
      startTimer();

      const qRes = await fetchAPI({ action: 'getQuestions', token, testId });
      if (qRes.status === 'error' && qRes.data.includes('already taken')) {
        alert('You have already taken this test. Redirecting...');
        window.location.href = 'index.html';
        return;
      }
      if (qRes.status !== 'success') { alert('Error loading questions'); return; }
      questions = qRes.data;
      
      // Load saved answers from localStorage (if any)
      const saved = localStorage.getItem(`answers_${testId}`);
      if (saved) {
        answers = JSON.parse(saved);
        // Update questionStatus based on answers
        questions.forEach((q, idx) => {
          if (answers[q.qId]) {
            if (answers[q.qId].isCorrect) questionStatus[idx] = 'correct';
            else questionStatus[idx] = 'wrong';
          } else {
            questionStatus[idx] = 'skipped'; // not answered yet
          }
        });
      } else {
        answers = {};
        questionStatus = new Array(questions.length).fill('skipped');
      }
      renderPalette();
      renderQuestion(0);
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) { clearInterval(timerInterval); submitTest(true); }
        const mins = Math.floor(timeLeft/60), secs = timeLeft%60;
        document.getElementById('timer').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        if (timeLeft < 60) document.getElementById('timer').classList.add('timer-critical');
      }, 1000);
    }

    // ---------- Palette ----------
    function renderPalette() {
      let html = '';
      questions.forEach((q, idx) => {
        let statusClass = 'palette-skipped';
        if (questionStatus[idx] === 'correct') statusClass = 'palette-correct';
        else if (questionStatus[idx] === 'wrong') statusClass = 'palette-wrong';
        else if (questionStatus[idx] === 'visited') statusClass = 'palette-answered'; // visited but not answered? treat as skipped
        const currentClass = (idx === currentIndex) ? 'palette-current' : '';
        html += `<div class="palette-btn ${statusClass} ${currentClass}" onclick="jumpToQuestion(${idx})">${idx+1}</div>`;
      });
      document.getElementById('paletteContainer').innerHTML = html;
    }

    window.jumpToQuestion = function(idx) {
      currentIndex = idx;
      renderQuestion(currentIndex);
      renderPalette();
    };

    // ---------- Question Rendering ----------
    function setLanguage(lang) { currentLang = lang; renderQuestion(currentIndex); }

    function renderQuestion(index) {
      if (!questions.length) return;
      const q = questions[index];
      document.getElementById('questionCounter').innerText = `Q${index+1}/${questions.length}`;
      document.getElementById('questionText').innerText = currentLang === 'en' ? q.qTextEng : (q.qTextHin || q.qTextEng);
      if (q.imageUrl) {
        document.getElementById('questionImage').classList.remove('hidden');
        document.getElementById('questionImage').querySelector('img').src = q.imageUrl;
      } else document.getElementById('questionImage').classList.add('hidden');

      const opts = [
        { id: '1', textEn: q.opt1Eng, textHi: q.opt1Hin || q.opt1Eng },
        { id: '2', textEn: q.opt2Eng, textHi: q.opt2Hin || q.opt2Eng },
        { id: '3', textEn: q.opt3Eng, textHi: q.opt3Hin || q.opt3Eng },
        { id: '4', textEn: q.opt4Eng, textHi: q.opt4Hin || q.opt4Eng }
      ];
      let html = '';
      opts.forEach(opt => {
        const optText = currentLang === 'en' ? opt.textEn : opt.textHi;
        const selected = (answers[q.qId] && answers[q.qId].selected === opt.id) ? 'selected' : '';
        html += `<div class="option p-4 rounded-xl border ${selected}" onclick="selectOption('${q.qId}','${opt.id}')"><span class="font-medium mr-3">${opt.id}.</span> ${optText}</div>`;
      });
      document.getElementById('optionsContainer').innerHTML = html;

      // Update visited status
      if (questionStatus[index] === 'skipped') questionStatus[index] = 'visited';
      renderPalette();

      // Nav buttons
      document.getElementById('prevBtn').disabled = index === 0;
      if (index === questions.length - 1) {
        document.getElementById('nextBtn').classList.add('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');
      } else {
        document.getElementById('nextBtn').classList.remove('hidden');
        document.getElementById('submitBtn').classList.add('hidden');
      }
    }

    // ---------- Answer Selection ----------
    window.selectOption = async function(qId, optId) {
      // Optimistic update
      answers[qId] = { selected: optId, isCorrect: false }; // will be updated after API
      // Find index
      const idx = questions.findIndex(q => q.qId === qId);
      
      // Call API
      const res = await fetchAPI({ action: 'submitAnswer', token, testId, qId, selected: optId });
      if (res.status === 'success') {
        answers[qId].isCorrect = res.data.isCorrect;
        if (res.data.isCorrect) questionStatus[idx] = 'correct';
        else questionStatus[idx] = 'wrong';
        localStorage.setItem(`answers_${testId}`, JSON.stringify(answers));
        renderPalette();
        renderQuestion(currentIndex); // refresh highlight
      } else {
        alert('Error submitting answer');
        delete answers[qId];
      }
    };

    function nextQuestion() { if (currentIndex < questions.length-1) { currentIndex++; renderQuestion(currentIndex); renderPalette(); } }
    function prevQuestion() { if (currentIndex > 0) { currentIndex--; renderQuestion(currentIndex); renderPalette(); } }

    // ---------- Submit Test ----------
    async function submitTest(forced = false) {
      clearInterval(timerInterval);
      if (!forced && !confirm('Submit test?')) { startTimer(); return; }
      const res = await fetchAPI({ action: 'submitTest', token, testId });
      if (res.status === 'success') {
        localStorage.removeItem(`answers_${testId}`);
        // Show modal popup
        showResultModal(res.data);
      } else {
        alert('Error: ' + res.data);
        window.location.href = 'index.html';
      }
    }

    function showResultModal(data) {
      document.getElementById('resultDetails').innerHTML = `
        <p>üìä Score: <span class="font-bold text-2xl text-blue-600">${data.score}</span></p>
        <p>üèÖ Rank: #${data.rank}</p>
        <p>‚úÖ Correct: ${data.correct || 0}</p>
        <p>‚ùå Wrong: ${data.wrong || 0}</p>
        <p>‚è≠Ô∏è Skipped: ${data.skipped || 0}</p>
        <p class="text-sm text-gray-500 mt-2">Total questions: ${data.total}</p>
      `;
      document.getElementById('resultModal').classList.remove('hidden');
    }

    window.closeResultModal = function() {
      document.getElementById('resultModal').classList.add('hidden');
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>
